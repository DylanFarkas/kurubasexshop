---
import type { Product } from "../../types/product";

const {
  title,
  subtitle = "Destacados",
  products = [],
  href = "#",
  id = "carousel",
} = Astro.props as {
  title: string;
  subtitle?: string;
  products: Product[];
  href?: string;
  id?: string;
};
---

<section class="w-full">
  <div class="flex items-end justify-between gap-4 mb-4">
    <div>
      <p class="text-xs tracking-widest uppercase text-neutral-500">{subtitle}</p>
      <h2 class="text-xl md:text-2xl font-semibold text-neutral-900">{title}</h2>
    </div>

    <div class="flex items-center gap-2">
      <a href={href} class="text-sm font-medium text-neutral-900 hover:underline">Ver todo</a>

      <button
        class="hidden md:inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-200 hover:border-neutral-300"
        data-prev={id}
        aria-label={`Anterior ${title}`}
        type="button"
      >
        ‹
      </button>
      <button
        class="hidden md:inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-200 hover:border-neutral-300"
        data-next={id}
        aria-label={`Siguiente ${title}`}
        type="button"
      >
        ›
      </button>
    </div>
  </div>

  <div
    id={id}
    class="relative -mx-4 px-4 overflow-x-auto scroll-smooth"
    style="scrollbar-width: none;"
  >
    <div class="flex gap-4 snap-x snap-mandatory">
      {products.map((p) => (
        <a
          href={p.slug ? `/producto/${p.slug}` : "#"}
          class="snap-start min-w-[72%] sm:min-w-[45%] md:min-w-[28%] lg:min-w-[22%] rounded-2xl border border-neutral-200 bg-white shadow-sm hover:shadow-md transition overflow-hidden"
        >
          <div class="aspect-4/5 bg-neutral-100">
            <img
              src={p.image ?? "/placeholder.png"}
              alt={p.name}
              class="h-full w-full object-cover"
              loading="lazy"
            />
          </div>

          <div class="p-4">
            <p class="text-xs text-neutral-500">{p.category}</p>
            <p class="mt-1 font-semibold text-neutral-900 line-clamp-2">{p.name}</p>

            <div class="mt-3 flex items-baseline gap-2">
              <span class="text-base font-semibold text-neutral-900">
                ${Intl.NumberFormat("es-CO").format(p.final_price ?? p.price)}
              </span>

              {p.final_price && p.final_price < p.price && (
                <>
                  <span class="text-sm text-neutral-400 line-through">
                    ${Intl.NumberFormat("es-CO").format(p.price)}
                  </span>
                  {typeof p.discount_pct === "number" && (
                    <span class="text-xs font-semibold text-emerald-700">
                      -{p.discount_pct}%
                    </span>
                  )}
                </>
              )}
            </div>

            <button
              class="mt-4 w-full rounded-xl bg-neutral-900 text-white py-2 text-sm font-medium hover:opacity-90"
              type="button"
            >
              Ver producto
            </button>
          </div>
        </a>
      ))}
    </div>
  </div>

  <script define:vars={{ id }}>
    const root = document.getElementById(id);
    if (root) {
      const prev = document.querySelector(`[data-prev="${id}"]`);
      const next = document.querySelector(`[data-next="${id}"]`);

      const scrollByCard = () => {
        // mueve aprox 1 tarjeta (la primera del carrusel)
        const card = root.querySelector("a");
        const gap = 16;
        return card ? card.getBoundingClientRect().width + gap : 320;
      };

      prev?.addEventListener("click", () => root.scrollBy({ left: -scrollByCard(), behavior: "smooth" }));
      next?.addEventListener("click", () => root.scrollBy({ left: scrollByCard(), behavior: "smooth" }));
    }
  </script>
</section>