---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase';
import { formatPrice } from '../../utils/formatters';
import type { Product } from '../../types/product';

export async function getStaticPaths() {
  const { data: products } = await supabase
    .from('products')
    .select('slug, active')
    .eq('active', true);
  
  return (products || []).map(product => ({
    params: { slug: product.slug },
  }));
}

const { slug } = Astro.params;

// Fetch producto con categoría
const { data: product, error } = await supabase
  .from('products')
  .select(`
    *,
    categories (
      label,
      slug
    )
  `)
  .eq('slug', slug)
  .single();

if (error || !product) {
  return Astro.redirect('/404');
}

const mappedProduct: Product = {
  ...product,
  categoryLabel: product.categories?.label,
  categorySlug: product.categories?.slug,
};

// Construir galería de imágenes: siempre incluir imagen principal
const galleryImages = [
  mappedProduct.image,
  ...(mappedProduct.images || [])
].filter(Boolean); // Filtrar undefined/null

const displayPrice = mappedProduct.final_price || mappedProduct.price;
const hasDiscount = !!mappedProduct.final_price && mappedProduct.final_price < mappedProduct.price;
---

<BaseLayout 
  title={`${mappedProduct.name} - Kuruba Sexshop`}
  description={mappedProduct.description || `Compra ${mappedProduct.name} en Kuruba Sexshop`}
>
  <main class="container mx-auto px-4 pt-20 pb-16">
    <div class="grid md:grid-cols-2 gap-8 lg:gap-16">
      <!-- Galería de imágenes -->
      <div class="space-y-4">
        <div class="aspect-square rounded-2xl overflow-hidden bg-gray-100">
          <img
            id="main-image"
            src={mappedProduct.image || '/placeholder.png'}
            alt={mappedProduct.name}
            class="w-full h-full object-cover"
          />
        </div>
        
        {galleryImages.length > 1 && (
          <div class="grid grid-cols-4 gap-2">
            {galleryImages.map((img, i) => (
              <button
                class="aspect-square rounded-lg overflow-hidden border-2 border-transparent hover:border-pink-500 transition thumbnail-btn"
                data-image={img}
              >
                <img src={img} alt={`${mappedProduct.name} ${i + 1}`} class="w-full h-full object-cover" />
              </button>
            ))}
          </div>
        )}
      </div>

      <!-- Información del producto -->
      <div class="space-y-6">
        {mappedProduct.categoryLabel && (
          <a
            href={`/categoria/${mappedProduct.categorySlug}`}
            class="inline-block text-sm text-pink-600 hover:underline"
          >
            {mappedProduct.categoryLabel}
          </a>
        )}
        
        <h1 class="text-4xl font-bold">{mappedProduct.name}</h1>
        
        {mappedProduct.description && (
          <p class="text-gray-600 leading-relaxed">{mappedProduct.description}</p>
        )}
        
        <div class="flex items-baseline gap-3">
          <span class="text-4xl font-bold">{formatPrice(displayPrice)}</span>
          {hasDiscount && (
            <>
              <span class="text-xl text-gray-400 line-through">{formatPrice(mappedProduct.price)}</span>
              <span class="px-2 py-1 bg-pink-100 text-pink-600 rounded text-sm font-semibold">
                -{mappedProduct.discount_pct}%
              </span>
            </>
          )}
        </div>
        
        <div class="space-y-3">
          <button
            id="add-to-cart"
            data-product={JSON.stringify({
              productId: mappedProduct.id,
              name: mappedProduct.name,
              slug: mappedProduct.slug,
              price: mappedProduct.price,
              finalPrice: mappedProduct.final_price,
              image: mappedProduct.image,
            })}
            class="w-full py-4 bg-pink-600 text-white rounded-lg font-semibold hover:bg-pink-700 transition"
          >
            Añadir al carrito
          </button>
          
          <a
            href="/tienda"
            class="block w-full py-4 border-2 border-gray-300 text-center rounded-lg font-semibold hover:border-pink-600 hover:text-pink-600 transition"
          >
            Seguir comprando
          </a>
        </div>
        
        <!-- Info adicional -->
        <div class="space-y-2 text-sm text-gray-600 pt-4 border-t">
          <p>✓ Producto bajo pedido (sin límite de stock)</p>
          <p>✓ Envío discreto</p>
          <p>✓ Pago seguro</p>
          <p>✓ Atención personalizada</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Cambio de imagen en galería
    const mainImage = document.getElementById('main-image') as HTMLImageElement;
    const thumbnails = document.querySelectorAll('.thumbnail-btn');
    
    thumbnails.forEach(btn => {
      btn.addEventListener('click', () => {
        const newSrc = (btn as HTMLElement).dataset.image;
        if (newSrc && mainImage) {
          mainImage.src = newSrc;
        }
      });
    });
    
    // Añadir al carrito (se conectará con Zustand en siguiente fase)
    const addToCartBtn = document.getElementById('add-to-cart');
    addToCartBtn?.addEventListener('click', () => {
      const productData = addToCartBtn.dataset.product;
      if (productData) {
        const product = JSON.parse(productData);
        // TODO: Conectar con useCartStore en Fase 4
        console.log('Añadir producto:', product);
        alert('Producto añadido al carrito!');
      }
    });
  </script>
</BaseLayout>