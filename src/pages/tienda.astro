---
import BaseLayout from "../layouts/BaseLayout.astro";
import ProductGrid from "../components/sections/ProductGrid.astro";
import FilterPanel from "../components/ui/FilterPanel.astro";
import { supabase } from "../lib/supabase";
import type { Product } from "../types/product";

const { data: products, error } = await supabase
    .from('products')
    .select(`*,categories (label,slug)`)
    .eq('active', true)
    .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching products:', error);
    }

const mappedProducts: Product[] = (products || []).map(p => ({
  ...p,
  categoryLabel: p.categories?.label,
  categorySlug: p.categories?.slug,
}));

const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .eq('active', true)
  .order('order_position');
---

<BaseLayout title="Tienda - Kuruba SexShop" description="Explora nuestro catÃ¡logo completo de productos">
    <main class="container mx-auto px-4 pt-20 pb-16">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-4xl font-bold">
                Todos los productos
            </h1>
            <button
                id="filter-trigger"
                class="flex items-center gap-2 px-4 py-2 bg-pink-600 text-white rounded-4xl hover:bg-pink-700 transition cursor-pointer"
            >
                Filtrar
            </button>
        </div>

        <ProductGrid products={mappedProducts} />
        <FilterPanel categories={categories || []} />
    </main>
</BaseLayout>