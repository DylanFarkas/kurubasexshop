---
import BaseAdminLayout from '../../../layouts/BaseAdminLayout.astro';
import ProductForm from '../../../components/admin/ProductForm';
import { supabase } from '../../../lib/supabase';
import { Icon } from 'astro-icon/components';

export const prerender = false;

// Obtener categorías activas
const { data: categories, error: categoriesError } = await supabase
  .from('categories')
  .select('id, label, slug')
  .eq('active', true)
  .order('order_position');

if (categoriesError) {
  console.error('Error fetching categories:', categoriesError);
}
---

<BaseAdminLayout title="Nuevo Producto">
  <div class="max-w-4xl">
    <div class="mb-6">
      <a 
        href="/admin/productos" 
        class="text-pink-600 dark:text-pink-400 hover:text-pink-700 dark:hover:text-pink-300 flex items-center gap-2 mb-4 transition-colors"
      >
      <Icon name="back" class="w-6 h-6" />
        Volver a Productos
      </a>
      
      <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">Nuevo Producto</h1>
      <p class="text-gray-600 dark:text-gray-400 mt-2">
        Crea un nuevo producto para tu tienda
      </p>
    </div>

    <ProductForm 
      client:load
      categories={categories || []}
      submitLabel="Crear Producto"
    />
  </div>
</BaseAdminLayout>

<script>
  // Mensaje de confirmación al salir sin guardar
  let formDirty = false;
  
  document.addEventListener('input', () => {
    formDirty = true;
  });

  window.addEventListener('beforeunload', (e) => {
    if (formDirty) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  document.querySelector('form')?.addEventListener('submit', () => {
    formDirty = false;
  });
</script>
