---
import { Icon } from 'astro-icon/components';
import StatCard from '../../../components/admin/StatCard';
import BaseAdminLayout from '../../../layouts/BaseAdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabaseAdmin';
import { formatPrice, formatDate } from '../../../utils/formatters';

export const prerender = false;

// --- URL params
const url = new URL(Astro.request.url);
const page = Math.max(1, Number(url.searchParams.get('page') ?? '1'));
const pageSize = Math.max(1, Number(url.searchParams.get('pageSize') ?? '10'));

const pageSizeOptions = [5, 10, 15];

const from = (page - 1) * pageSize;
const to = from + pageSize - 1;

const [
  { data: products, error, count },
  { count: activeCount },
  { count: featuredCount }
] = await Promise.all([
  supabaseAdmin
    .from('products')
    .select(
      `
        *,
        categories (
          label,
          slug
        )
      `,
      { count: 'exact' }
    )
    .order('created_at', { ascending: false })
    .range(from, to),
  
  supabaseAdmin
    .from('products')
    .select('*', { count: 'exact', head: true })
    .eq('active', true),
  
  supabaseAdmin
    .from('products')
    .select('*', { count: 'exact', head: true })
    .eq('featured', true)
]);

if (error) console.error('Error fetching products:', error);

const total = count ?? 0;
const totalPages = Math.max(1, Math.ceil(total / pageSize));
const prevPage = page > 1 ? page - 1 : null;
const nextPage = page < totalPages ? page + 1 : null;

function pageHref(p: number) {
  const u = new URL(Astro.request.url);
  u.searchParams.set('page', String(p));
  return u.pathname + u.search;
}

function pageSizeHref(size: number) {
  const u = new URL(Astro.request.url);
  u.searchParams.set('pageSize', String(size));
  u.searchParams.set('page', '1'); 
  return u.pathname + u.search;
}

const windowSize = 5;
let start = Math.max(1, page - Math.floor(windowSize / 2));
let end = Math.min(totalPages, start + windowSize - 1);

if (end - start + 1 < windowSize) {
  start = Math.max(1, end - windowSize + 1);
}

const pages = Array.from({ length: end - start + 1 }, (_, i) => start + i);
---

<BaseAdminLayout title="Productos">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <p class="text-gray-600 text-sm">Gestiona el catálogo completo de tu tienda</p>
    </div>

    <a
      href="/admin/productos/nuevo"
      class="px-5 py-2.5 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-all flex items-center gap-2 font-medium"
    >
    <Icon name="plus" class="w-6 h-6" />
      Nuevo Producto
    </a>
  </div>

  {/* Estadísticas */}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 transition-colors">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Productos</p>
          <p class="text-3xl font-bold text-gray-900 dark:text-gray-100 mt-1">{total}</p>
        </div>
        <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
          <Icon name="box" class="w-6 h-6 text-white" />
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 transition-colors">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Productos Activos</p>
          <p class="text-3xl font-bold text-green-600 dark:text-green-400 mt-1">{activeCount ?? 0}</p>
        </div>
        <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
          <Icon name="check" class="w-6 h-6 text-white" />
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 transition-colors">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Productos Destacados</p>
          <p class="text-3xl font-bold text-pink-600 dark:text-pink-400 mt-1">{featuredCount ?? 0}</p>
        </div>
        <div class="w-12 h-12 bg-pink-500 rounded-lg flex items-center justify-center">
          <Icon name="star" class="w-6 h-6 text-white" />
        </div>
      </div>
    </div>
  </div>

  {/* Selector de tamaño de página */}
  <div class="mb-4 flex justify-between items-center">
    <div class="text-sm text-gray-600 dark:text-gray-400">
      Mostrando <span class="font-semibold text-gray-900 dark:text-gray-100">{from + 1}</span>–
      <span class="font-semibold text-gray-900 dark:text-gray-100">{Math.min(from + pageSize, total)}</span> de
      <span class="font-semibold text-gray-900 dark:text-gray-100"> {total}</span> productos
    </div>
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-600 dark:text-gray-400 font-medium">Mostrar:</label>
      <div class="flex items-center gap-1">
        {pageSizeOptions.map(size => (
          <a
            href={pageSizeHref(size)}
            class:list={[
              "px-3 py-2 rounded-lg text-sm font-medium transition-all",
              size === pageSize 
                ? "bg-pink-500 text-white" 
                : "bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-pink-300 dark:hover:border-pink-500 text-gray-700 dark:text-gray-300 hover:bg-pink-50 dark:hover:bg-pink-900/20"
            ]}
          >
            {size}
          </a>
        ))}
      </div>
    </div>
  </div>

  {/* Tabla de Productos */}
  <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-colors">{products && products.length > 0 ? (
      <>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-linear-to-r from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-900">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Imagen</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Producto</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Categoría</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Precio</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Estado</th>              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Creado</th>
                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>

            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              {products.map((product) => (
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap">
                    {product.image ? (
                      <img
                        src={product.image}
                        alt={product.name}
                        class="w-16 h-20 object-cover rounded-lg border border-gray-200 dark:border-gray-700"
                      />
                    ) : (
                      <div class="w-16 h-20 bg-linear-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 flex items-center justify-center">
                        <Icon name="photo" class="w-6 h-6 text-gray-400" />
                      </div>
                    )}
                  </td>

                  <td class="px-6 py-4">
                    <div class="flex flex-col gap-1">
                      <span class="text-sm font-semibold text-gray-900 dark:text-gray-100">{product.name}</span>
                      <span class="text-xs text-gray-500 dark:text-gray-400 font-mono">/{product.slug}</span>
                      {product.featured && (
                        <span class="mt-0.5 inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-linear-to-r from-pink-100 to-pink-200 dark:from-pink-900/30 dark:to-pink-800/30 text-pink-800 dark:text-pink-300 w-fit border border-pink-300 dark:border-pink-700">
                          <Icon name="star" class="w-3 h-3 mr-1" />
                          Destacado
                        </span>
                      )}
                    </div>
                  </td>

                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                      {product.categories?.label || 'Sin categoría'}
                    </span>
                  </td>

                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col gap-0.5">
                      {product.discount_pct && product.discount_pct > 0 && product.final_price ? (
                        <>
                          <span class="text-sm font-bold text-pink-600 dark:text-pink-400">{formatPrice(product.final_price)}</span>
                          <span class="text-xs text-gray-500 dark:text-gray-400 line-through">{formatPrice(product.price)}</span>
                          <span class="text-xs font-semibold text-pink-600 dark:text-pink-400 bg-pink-50 dark:bg-pink-900/30 px-2 py-0.5 rounded-md w-fit">-{product.discount_pct}%</span>
                        </>
                      ) : (
                        <span class="text-sm font-semibold text-gray-900 dark:text-gray-100">{formatPrice(product.price)}</span>
                      )}
                    </div>
                  </td>

                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${
                      product.active 
                        ? 'bg-green-100 text-green-800 border border-green-200' 
                        : 'bg-gray-100 text-gray-800 border border-gray-200'
                    }`}>
                      <span class={`w-1.5 h-1.5 rounded-full mr-1.5 ${product.active ? 'bg-green-500' : 'bg-gray-500'}`}></span>
                      {product.active ? 'Activo' : 'Inactivo'}
                    </span>
                  </td>

                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {formatDate(product.created_at)}
                  </td>

                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <div class="flex items-center justify-end gap-2">
                      <a
                        href={`/producto/${product.slug}`}
                        target="_blank"
                        class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all"
                        title="Ver producto"
                      >
                        <Icon name="eye" class="w-5 h-5" />
                      </a>

                      <a
                        href={`/admin/productos/${product.id}`}
                        class="p-2 text-pink-600 hover:text-pink-900 hover:bg-pink-50 rounded-lg transition-all"
                        title="Editar producto"
                      >
                        <Icon name="edit" class="w-5 h-5" />
                      </a>

                      <button
                        class="delete-btn p-2 text-red-600 hover:text-red-900 hover:bg-red-50 rounded-lg transition-all cursor-pointer"
                        data-product-id={product.id}
                        data-product-name={product.name}
                        title="Eliminar producto"
                      >
                        <Icon name="delete" class="w-5 h-5" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* Footer paginación */}
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 px-6 py-4 border-t border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-900">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Mostrando <span class="font-semibold text-gray-900 dark:text-gray-300">{from + 1}</span>–
            <span class="font-semibold text-gray-900 dark:text-gray-300">{Math.min(from + pageSize, total)}</span> de
            <span class="font-semibold text-gray-900 dark:text-gray-300"> {total}</span> productos
          </p>

          <div class="flex items-center gap-2">
            <a
              href={prevPage ? pageHref(prevPage) : '#'}
              class:list={[
                "px-4 py-2 rounded-lg border text-sm font-medium transition-all flex items-center gap-2",
                prevPage 
                  ? "bg-white dark:bg-gray-800 hover:bg-gray-50 text-gray-700 border-gray-200" 
                  : "bg-gray-100 dark:bg-gray-600 text-gray-400 cursor-not-allowed pointer-events-none border-gray-200"
              ]}
            >
              <Icon name="back" class="w-4 h-4" />
              Anterior
            </a>

            <div class="flex items-center gap-1">
              {/* Primera página si no está visible */}
              {start > 1 && (
                <>
                  <a
                    href={pageHref(1)}
                    class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm font-medium hover:bg-gray-50 text-gray-700 transition-all"
                  >
                    1
                  </a>
                  {start > 2 && <span class="px-2 text-gray-400">...</span>}
                </>
              )}

              {/* Páginas visibles */}
              {pages.map(p => (
                <a
                  href={pageHref(p)}
                  class:list={[
                    "px-3 py-2 rounded-lg border text-sm font-medium transition-all",
                    p === page 
                      ? "bg-pink-500 text-white border-pink-600" 
                      : "bg-white hover:bg-gray-50 text-gray-700 border-gray-200"
                  ]}
                >
                  {p}
                </a>
              ))}

              {/* Última página si no está visible */}
              {end < totalPages && (
                <>
                  {end < totalPages - 1 && <span class="px-2 text-gray-400">...</span>}
                  <a
                    href={pageHref(totalPages)}
                    class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm font-medium hover:bg-gray-50 text-gray-700 transition-all"
                  >
                    {totalPages}
                  </a>
                </>
              )}
            </div>

            <a
              href={nextPage ? pageHref(nextPage) : '#'}
              class:list={[
                "px-4 py-2 rounded-lg border text-sm font-medium transition-all flex items-center gap-2",
                nextPage 
                  ? "bg-white dark:bg-gray-800 hover:bg-gray-50 text-gray-700 border-gray-200" 
                  : "bg-gray-100 dark:bg-gray-600 text-gray-400 cursor-not-allowed pointer-events-none border-gray-200"
              ]}
            >
              Siguiente
              <Icon name="enter" class="w-4 h-4" />
            </a>
          </div>
        </div>
      </>
    ) : (
      <div class="text-center py-16">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-linear-to-br from-pink-100 to-pink-200 mb-4">
          <Icon name="box" class="w-8 h-8 text-pink-600" />
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-1">No hay productos</h3>
        <p class="text-sm text-gray-600 mb-6">Comienza creando tu primer producto para el catálogo</p>
        <a
          href="/admin/productos/nuevo"
          class="inline-flex items-center px-5 py-2.5 bg-linear-to-r from-pink-500 to-pink-600 text-white rounded-lg hover:from-pink-600 hover:to-pink-700 transition-all font-medium"
        >
          <Icon name="plus" class="w-5 h-5 mr-2" />
          Crear Primer Producto
        </a>
      </div>
    )}
  </div>

  <!-- Modal de confirmación para eliminar -->
  <div id="deleteModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl border border-gray-200 max-w-md w-full mx-auto transform transition-all">
      <div class="p-6">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
            <Icon name="warning" class="w-6 h-6 text-red-600" />
          </div>
          <div class="flex-1">
            <h3 class="text-xl font-bold text-gray-900">¿Eliminar producto?</h3>
            <p class="text-sm text-gray-500 mt-0.5">Esta acción no se puede deshacer</p>
          </div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-900">Estás a punto de eliminar:</p>
          <p class="font-semibold text-gray-900 mt-1" id="productName"></p>
          <p class="text-xs text-gray-600 mt-2">El producto será eliminado permanentemente de tu catálogo.</p>
        </div>
        <div class="flex gap-3">
          <button 
            id="cancelDelete" 
            type="button" 
            class="flex-1 px-4 py-2.5 border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-all font-medium text-gray-700 cursor-pointer"
          >
            Cancelar
          </button>
          <button 
            id="confirmDelete" 
            type="button" 
            class="flex-1 px-4 py-2.5 bg-linear-to-r from-red-500 to-red-600 text-white rounded-lg hover:from-red-600 hover:to-red-700 transition-all font-medium cursor-pointer"
          >
            Sí, eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseAdminLayout>

<script>
  const deleteModal = document.getElementById('deleteModal');
  const productNameEl = document.getElementById('productName');
  const cancelDelete = document.getElementById('cancelDelete');
  const confirmDelete = document.getElementById('confirmDelete');

  let productIdToDelete: string | null = null;

  document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      productIdToDelete = target.dataset.productId || null;
      const productName = target.dataset.productName || '';

      if (productNameEl) productNameEl.textContent = productName;
      deleteModal?.classList.remove('hidden');
      deleteModal?.classList.add('flex');
    });
  });

  cancelDelete?.addEventListener('click', () => {
    deleteModal?.classList.add('hidden');
    deleteModal?.classList.remove('flex');
    productIdToDelete = null;
  });

  confirmDelete?.addEventListener('click', async () => {
    if (!productIdToDelete) return;

    try {
      (confirmDelete as HTMLButtonElement).disabled = true;
      confirmDelete.textContent = 'Eliminando...';

      const response = await fetch('/api/products/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ id: productIdToDelete })
      });

      const data = await response.json();

      if (data.success) window.location.reload();
      else {
        alert('Error al eliminar: ' + data.message);
        (confirmDelete as HTMLButtonElement).disabled = false;
        confirmDelete.textContent = 'Eliminar';
      }
    } catch (err) {
      console.error(err);
      alert('Error al eliminar el producto');
      (confirmDelete as HTMLButtonElement).disabled = false;
      confirmDelete.textContent = 'Eliminar';
    }
  });
</script>