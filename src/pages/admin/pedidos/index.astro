---
import BaseAdminLayout from '../../../layouts/BaseAdminLayout.astro';
import OrdersTable from '../../../components/admin/OrdersTable';
import StatCard from '../../../components/admin/StatCard';
import { supabaseAdmin } from '../../../lib/supabaseAdmin';
import { formatPrice } from '../../../utils/formatters';
import type { Order } from '../../../types/order';

export const prerender = false;

// Obtener todas las órdenes con estadísticas en paralelo
const [
  { data: orders, error },
  { count: pendingCount },
  { count: confirmedCount },
  { count: deliveredCount }
] = await Promise.all([
  supabaseAdmin
    .from('orders')
    .select('*')
    .order('created_at', { ascending: false }),
  
  supabaseAdmin
    .from('orders')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'pending'),
  
  supabaseAdmin
    .from('orders')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'confirmed'),
  
  supabaseAdmin
    .from('orders')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'delivered')
]);

if (error) {
  console.error('Error fetching orders:', error);
}

const ordersData = (orders || []) as Order[];

// Calcular total de ventas
const totalSales = ordersData
  .filter(order => order.status !== 'cancelled')
  .reduce((sum, order) => sum + order.total, 0);

// Calcular promedio de venta
const avgOrderValue = ordersData.length > 0 ? totalSales / ordersData.length : 0;
---

<BaseAdminLayout title="Gestión de Pedidos">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Pedidos</h1>
        <p class="mt-2 text-sm text-gray-600">
          Gestiona y realiza seguimiento de todos los pedidos
        </p>
      </div>
    </div>

    <!-- Tarjetas de estadísticas -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <StatCard 
        label="Total de pedidos" 
        value={ordersData.length} 
        color="text-blue-600" 
      />
      <StatCard 
        label="Pendientes" 
        value={pendingCount || 0} 
        color="text-yellow-600" 
      />
      <StatCard 
        label="Confirmados" 
        value={confirmedCount || 0} 
        color="text-green-600" 
      />
      <StatCard 
        label="Entregados" 
        value={deliveredCount || 0} 
        color="text-purple-600" 
      />
    </div>

    <!-- Estadísticas de ventas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-linear-to-br from-pink-500 to-pink-600 rounded-lg shadow p-6 text-white">
        <p class="text-sm opacity-90">Total en ventas</p>
        <p class="text-3xl font-bold mt-2">{formatPrice(totalSales)}</p>
      </div>
      <div class="bg-linear-to-br from-purple-500 to-purple-600 rounded-lg shadow p-6 text-white">
        <p class="text-sm opacity-90">Promedio por pedido</p>
        <p class="text-3xl font-bold mt-2">{formatPrice(avgOrderValue)}</p>
      </div>
    </div>

    <!-- Tabla de órdenes -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Todos los pedidos</h2>
      <OrdersTable orders={ordersData} client:load />
    </div>
  </div>
</BaseAdminLayout>
