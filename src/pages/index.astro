---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/sections/Hero.astro';
import CategoriesGrid from '../components/sections/CategoriesGrid.astro';
import FeaturedCarousel from '../components/sections/FeaturedCarousel.astro';
import { supabase } from '../lib/supabase';
import AboutUs from '../components/sections/AboutUs.astro';
import Feedback from '../components/sections/Feedback.astro';

const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .eq('active', true)
  .order('order_position');

const featuredByCategory = new Map();

if (categories) {
  for (const category of categories) {
    const { data: products } = await supabase
      .from('products')
      .select(`
        *,
        categories (
          label,
          slug
        )
      `)
      .eq('category_id', category.id)
      .eq('active', true)
      .eq('featured', true)
      .limit(8);
    
    if (products && products.length > 0) {
      featuredByCategory.set(category.slug, {
        category: category.label,
        products: products.map(p => ({
          ...p,
          categoryLabel: p.categories?.label,
          categorySlug: p.categories?.slug,
        })),
      });
    }
  }
}
---

<BaseLayout 
  title="Kuruba Sexshop - Tu tienda de confianza"
  description="Encuentra los mejores productos para tu bienestar Ã­ntimo"
>
  <Hero />
  <CategoriesGrid />
  <FeaturedCarousel featuredByCategory={Object.fromEntries(featuredByCategory)} />
  <Feedback />
  <AboutUs />
</BaseLayout>